<html>
<head>
<meta charset="UTF-8">
<script language="javascript" type="text/javascript" src="scripts/p5.js"></script>
<script language="javascript" type="text/javascript" src="scripts/p5.play.js"></script>
<script language="javascript" type="text/javascript" src="scripts/p5.dom.js"></script>
<script language="javascript" type="text/javascript" src="scripts/virtualjoystick.js"></script>
</head>
<body>
<script>
var joystick = new VirtualJoystick({
container : document.getElementById('defaultCanvas0'),
mouseSupport : true,
});


function setup() {
    createCanvas(1100, 600);
    bgImage = loadImage('assets/cavebg.png');
    terrainTop = loadImage('assets/terrain_top.png');
    terrainBottom = loadImage('assets/terrain_bottom.png');
    shipImage = loadImage('assets/ship-side.png');
    shipUpImage = loadImage('assets/ship-side-right_under.png');
    shipDownImage = loadImage('assets/ship-side-left.png');
    shipPhasedImage = loadImage('assets/ship-side-phased.png');
    ship = createSprite(64, height/2);
    ship.addImage("normal", shipImage);
    ship.addImage("up", shipUpImage);
    ship.addImage("down", shipDownImage);
    ship.addImage("phased", shipPhasedImage);
    ship.score = 10;
    turretImage = loadImage('assets/turret.png');
    turrets = new Group();
    boomImage = loadImage('assets/explosion0001.png');
    bulletImage = loadImage('assets/fb_o.png');
    bullets = new Group();
    fbImage = loadImage('assets/fireball_small.png');
    fireballs = new Group();
}

function draw() {
    background(0);
    for (var i = 0; i < turrets.length; i++) {
        var t = turrets[i];
        var turret_y = t.position.x - t.position.y;
        var ship_x = ship.position.x - ship.position.y;
        var atan_rot = Math.atan2(turret_y, ship_x) * 180 / Math.PI;
        if (t.position.x > ship.position.x)
            t.rotation = atan_rot;
        else
            t.rotation = -1 * atan_rot;
    }

    if (frameCount%60 == 0) {
        for (var i = 0; i < turrets.length; i++) {
            var fbspeed = random(5, 30)
            var fb = createSprite(t.position.x, t.position.y);
            fb.addImage(fbImage);
            fb.attractionPoint(fbspeed, ship.position.x, ship.position.y);
            fireballs.add(fb);
        }
    }
     
    if (frameCount%60 == 0) {
        var turretSpacing = random(700, 900);
        if (turretSpacing > 800) {
            var turret = createSprite(ship.position.x + turretSpacing, 35, 75, 75);
            turret.addImage(turretImage);
            turret.addAnimation("boom", 'assets/explosion0001.png', 'assets/explosion0003.png');
            turrets.add(turret);
        }
        if (turretSpacing < 800) {
            turret = createSprite(ship.position.x + turretSpacing, 565, 75, 75);
            turret.mirrorY(-1);
            turret.addImage(turretImage);
            turret.addAnimation("boom", 'assets/explosion0001.png', 'assets/explosion0003.png');
            turrets.add(turret);
        }
    }

    for (var i = 0; i < fireballs.length; i++)
        if (fireballs[i].position.x < width || fireballs[i].position.y < 0)
            fireballs[i].remove();
    for (var i = 0; i < turrets.length; i++)
        if (turrets[i].position.x < ship.position.x - width/2)
            turrets[i].remove();

    camera.position.x = ship.position.x + width/4;
    
    ship.up = function() {
        ship.changeAnimation("up");
        ship.position.y = ship.position.y - 10;
        if (ship.position.y > 0) {
            ship.rotation -= 1;
        }
    }
    ship.down = function() {
        ship.changeAnimation("down");
        ship.position.y = ship.position.y + 10;
        if (ship.position.y < 600) { 
            ship.rotation += 1;
        }
    }
    ship.right = function() {
            ship.changeAnimation("normal");
            ship.position.x = ship.position.x + 10;
    }
    ship.left = function() {
            ship.changeAnimation("normal");
        if (ship.position.x >= 0) {
            ship.position.x = ship.position.x - 10;
	    }
    }
 	
    /* arrow key and wasd keyboard controls */
    if (keyIsDown(UP_ARROW) || keyIsDown(87))
		ship.up();
	if (keyIsDown(DOWN_ARROW) || keyIsDown(83))
		ship.down();
	if (keyIsDown(RIGHT_ARROW) || keyIsDown(68))
		ship.right();
	if (keyIsDown(LEFT_ARROW) || keyIsDown(65))
		ship.left();

	joystick.right() ? ship.right() : '';
	joystick.up() ? ship.up() : '';
	joystick.left() ? ship.left() : '';
	joystick.down() ? ship.down() : '';

    ship.update = function() {
        if (ship.position.y > height) {
          ship.position.y = height;
        }
        if (ship.position.y < 0) {
          ship.position.y = 0;
        }
        ship.position.x = ship.position.x + 2;
    }

    if (keyWentDown('SPACE')) {
        var bullet = createSprite(ship.position.x, ship.position.y);
        bullet.addImage(bulletImage);
        bullet.setSpeed(30, ship.rotation);
        bullet.life = 30;
        bullets.add(bullet);
    }

    /* when ship shoots turrets */
    bullets.collide(turrets, explosion);
    function explosion(spriteA, spriteB) {
        spriteB.changeAnimation("boom");
        spriteA.remove(); /* remove bullet that ship fired */
       /* spriteB.remove(); remove turret that was hit*/
    }

    /* when turrets shoot ship */
    fireballs.collide(ship, shipHit);
    function shipHit(spriteA, spriteB) {
        spriteA.remove() /* remove fireball that hit ship */ 
        ship.changeAnimation("phased");
        spriteB.score--;
    }
    camera.off();
    image(bgImage, 0, 0);
    image(terrainTop, 0, 0);
    image(terrainBottom, 0, 565);
    camera.on();
    drawSprites();
}
joystick.addEventListener('touchStart', function(){
    console.log('down')
})
joystick.addEventListener('touchEnd', function(){
    console.log('up')
})
</script>
</body>
</html>
